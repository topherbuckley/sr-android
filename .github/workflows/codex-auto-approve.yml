name: Codex Auto-Approve

on:
  pull_request_review_thread:
    types: [resolved, unresolved]
  pull_request_review_comment:
    types: [created, edited, deleted]

permissions:
  contents: read
  pull-requests: write

jobs:
  codex-auto-approve:
    if: contains(fromJSON('["MEMBER","OWNER"]'), github.event.pull_request.author_association)
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve when Codex threads are resolved
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request in event payload.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;

            const botLogins = new Set(['github-actions', 'github-actions[bot]']);

            const threads = await github.rest.pulls.listReviewThreads({
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const codexThreads = threads.data.filter((thread) =>
              thread.comments.some((comment) => botLogins.has(comment.user?.login))
            );

            if (codexThreads.length === 0) {
              core.info('No Codex review threads found.');
              return;
            }

            const unresolved = codexThreads.filter((thread) => !thread.isResolved);
            if (unresolved.length > 0) {
              core.info(`Codex threads unresolved: ${unresolved.length}`);
              return;
            }

            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const codexReviews = reviews.data.filter((review) =>
              botLogins.has(review.user?.login)
            );

            if (codexReviews.length === 0) {
              core.info('No Codex reviews found.');
              return;
            }

            const latest = codexReviews[codexReviews.length - 1];
            if (latest.state !== 'CHANGES_REQUESTED') {
              core.info(`Latest Codex review state is ${latest.state}. No approval needed.`);
              return;
            }

            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
              body: 'All Codex review threads are resolved. Auto-approving.'
            });
